import { HttpResponse } from '@angular/common/http';
import { Inject, Injectable } from '@angular/core';
import { HTTP_CACHE_CONFIG } from './cache-config';
import { CacheBucket } from './cache-bucket';
import * as i0 from "@angular/core";
import * as i1 from "./requests-queue";
import * as i2 from "./cache-storage";
import * as i3 from "./cache-guard";
import * as i4 from "./ttl-manager";
import * as i5 from "./requests-cache";
import * as i6 from "./versions";
export class HttpCacheManager {
    constructor(queue, storage, guard, ttlManager, requests, version, config) {
        this.queue = queue;
        this.storage = storage;
        this.guard = guard;
        this.ttlManager = ttlManager;
        this.requests = requests;
        this.version = version;
        this.config = config;
    }
    validate(key) {
        const has = this.storage.has(key);
        const isValid = this.ttlManager.isValid(key);
        if (has && isValid)
            return true;
        this.storage.delete(key);
        return false;
    }
    get(key) {
        return this._resolveResponse(this.storage.get(key));
    }
    has(key) {
        return this.storage.has(key);
    }
    set(key, body, { ttl, bucket } = {}) {
        let response = body;
        if (!(body instanceof HttpResponse)) {
            response = new HttpResponse({
                body,
                status: 200,
                url: key
            });
        }
        this._set(key, response, ttl);
        bucket && bucket.add(key);
    }
    delete(key, { deleteRequests, deleteVersions } = {}) {
        if (key instanceof CacheBucket) {
            key.forEach(value => this.delete(value));
            key.clear();
            return;
        }
        this.storage.delete(key);
        this.ttlManager.delete(key);
        this.queue.delete(key);
        if (deleteRequests !== false) {
            this._getRequests().delete(key);
        }
        if (deleteVersions !== false) {
            this._getVersions().delete(key);
        }
    }
    clear() {
        this.storage.clear();
        this.ttlManager.clear();
        this.queue.clear();
        this._getVersions().clear();
        this._getRequests().clear();
    }
    _getQueue() {
        return this.queue;
    }
    _getRequests() {
        return this.requests;
    }
    _getVersions() {
        return this.version;
    }
    _isCacheable(canActivate, cache) {
        const strategy = this.config.strategy;
        if (strategy === 'explicit') {
            return cache;
        }
        if (canActivate && strategy === 'implicit') {
            return cache !== false;
        }
        return false;
    }
    _set(key, response, ttl) {
        this.storage.set(key, response);
        this.ttlManager.set(key, ttl);
    }
    _canActivate(request) {
        return this.guard.canActivate(request);
    }
    _resolveResponse(event) {
        return this.config.responseSerializer ? event.clone({ body: this.config.responseSerializer(event.body) }) : event;
    }
}
HttpCacheManager.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "14.2.10", ngImport: i0, type: HttpCacheManager, deps: [{ token: i1.RequestsQueue }, { token: i2.HttpCacheStorage }, { token: i3.HttpCacheGuard }, { token: i4.TTLManager }, { token: i5.RequestsCache }, { token: i6.HttpCacheVersions }, { token: HTTP_CACHE_CONFIG }], target: i0.ɵɵFactoryTarget.Injectable });
HttpCacheManager.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "14.2.10", ngImport: i0, type: HttpCacheManager });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "14.2.10", ngImport: i0, type: HttpCacheManager, decorators: [{
            type: Injectable
        }], ctorParameters: function () { return [{ type: i1.RequestsQueue }, { type: i2.HttpCacheStorage }, { type: i3.HttpCacheGuard }, { type: i4.TTLManager }, { type: i5.RequestsCache }, { type: i6.HttpCacheVersions }, { type: undefined, decorators: [{
                    type: Inject,
                    args: [HTTP_CACHE_CONFIG]
                }] }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2FjaGUtbWFuYWdlci5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vcHJvamVjdHMvbmduZWF0L2Nhc2hldy9zcmMvbGliL2NhY2hlLW1hbmFnZXIuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQWUsWUFBWSxFQUFFLE1BQU0sc0JBQXNCLENBQUM7QUFDakUsT0FBTyxFQUFFLE1BQU0sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDbkQsT0FBTyxFQUFFLGlCQUFpQixFQUFtQixNQUFNLGdCQUFnQixDQUFDO0FBS3BFLE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQzs7Ozs7Ozs7QUFLN0MsTUFBTSxPQUFPLGdCQUFnQjtJQUMzQixZQUNVLEtBQW9CLEVBQ3BCLE9BQXlCLEVBQ3pCLEtBQXFCLEVBQ3JCLFVBQXNCLEVBQ3RCLFFBQXVCLEVBQ3ZCLE9BQTBCLEVBQ0MsTUFBdUI7UUFObEQsVUFBSyxHQUFMLEtBQUssQ0FBZTtRQUNwQixZQUFPLEdBQVAsT0FBTyxDQUFrQjtRQUN6QixVQUFLLEdBQUwsS0FBSyxDQUFnQjtRQUNyQixlQUFVLEdBQVYsVUFBVSxDQUFZO1FBQ3RCLGFBQVEsR0FBUixRQUFRLENBQWU7UUFDdkIsWUFBTyxHQUFQLE9BQU8sQ0FBbUI7UUFDQyxXQUFNLEdBQU4sTUFBTSxDQUFpQjtJQUN6RCxDQUFDO0lBRUosUUFBUSxDQUFDLEdBQVc7UUFDbEIsTUFBTSxHQUFHLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDbEMsTUFBTSxPQUFPLEdBQUcsSUFBSSxDQUFDLFVBQVUsQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLENBQUM7UUFFN0MsSUFBSSxHQUFHLElBQUksT0FBTztZQUFFLE9BQU8sSUFBSSxDQUFDO1FBRWhDLElBQUksQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFD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LEtBQUssQ0FBQztJQUNmLENBQUM7SUFFRCxJQUFJLENBQUMsR0FBVyxFQUFFLFFBQXFDLEVBQUUsR0FBVztRQUNsRSxJQUFJLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxHQUFHLEVBQUUsUUFBUSxDQUFDLENBQUM7UUFDaEMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxHQUFHLENBQUMsR0FBRyxFQUFFLEdBQUcsQ0FBQyxDQUFDO0lBQ2hDLENBQUM7SUFFRCxZQUFZLENBQUMsT0FBeUI7UUFDcEMsT0FBTyxJQUFJLENBQUMsS0FBSyxDQUFDLFdBQVcsQ0FBQyxPQUFPLENBQUMsQ0FBQztJQUN6QyxDQUFDO0lBRUQsZ0JBQWdCLENBQVUsS0FBc0I7UUFDOUMsT0FBTyxJQUFJLENBQUMsTUFBTSxDQUFDLGtCQUFrQixDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLEVBQUUsSUFBSSxFQUFFLElBQUksQ0FBQyxNQUFNLENBQUMsa0JBQWtCLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDO0lBQ3BILENBQUM7OzhHQWxIVSxnQkFBZ0IscU1BUWpCLGlCQUFpQjtrSEFSaEIsZ0JBQWdCOzRGQUFoQixnQkFBZ0I7a0JBRDVCLFVBQVU7OzBCQVNOLE1BQU07MkJBQUMsaUJBQWlCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSHR0cFJlcXVlc3QsIEh0dHBSZXNwb25zZSB9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbi9odHRwJztcbmltcG9ydCB7IEluamVjdCwgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgSFRUUF9DQUNIRV9DT05GSUcsIEh0dHBDYWNoZUNvbmZpZyB9IGZyb20gJy4vY2FjaGUtY29uZmlnJztcbmltcG9ydCB7IEh0dHBDYWNoZVN0b3JhZ2UgfSBmcm9tICcuL2NhY2hlLXN0b3JhZ2UnO1xuaW1wb3J0IHsgVFRMTWFuYWdlciB9IGZyb20gJy4vdHRsLW1hbmFnZXInO1xuaW1wb3J0IHsgSHR0cENhY2hlR3VhcmQgfSBmcm9tICcuL2NhY2hlLWd1YXJkJztcbmltcG9ydCB7IFJlcXVlc3RzUXVldWUgfSBmcm9tICcuL3JlcXVlc3RzLXF1ZXVlJztcbmltcG9ydCB7IENhY2hlQnVja2V0IH0gZnJvbSAnLi9jYWNoZS1idWNrZXQnO1xuaW1wb3J0IHsgUmVxdWVzdHNDYWNoZSB9IGZyb20gJy4vcmVxdWVzdHMtY2FjaGUnO1xuaW1wb3J0IHsgSHR0cENhY2hlVmVyc2lvbnMgfSBmcm9tICcuL3ZlcnNpb25zJztcblxuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIEh0dHBDYWNoZU1hbmFnZXIge1xuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIHF1ZXVlOiBSZXF1ZXN0c1F1ZXVlLFxuICAgIHByaXZhdGUgc3RvcmFnZTogSHR0cENhY2hlU3RvcmFnZSxcbiAgICBwcml2YXRlIGd1YXJkOiBIdHRwQ2FjaGVHdWFyZCxcbiAgICBwcml2YXRlIHR0bE1hbmFnZXI6IFRUTE1hbmFnZXIsXG4gICAgcHJpdmF0ZSByZXF1ZXN0czogUmVxdWVzdHNDYWNoZSxcbiAgICBwcml2YXRlIHZlcnNpb246IEh0dHBDYWNoZVZlcnNpb25zLFxuICAgIEBJbmplY3QoSFRUUF9DQUNIRV9DT05GSUcpIHByaXZhdGUgY29uZmlnOiBIdHRwQ2FjaGVDb25maWdcbiAgKSB7fVxuXG4gIHZhbGlkYXRlKGtleTogc3RyaW5nKSB7XG4gICAgY29uc3QgaGFzID0gdGhpcy5zdG9yYWdlLmhhcyhrZXkpO1xuICAgIGNvbnN0IGlzVmFsaWQgPSB0aGlzLnR0bE1hbmFnZXIuaXNWYWxpZChrZXkpO1xuXG4gICAgaWYgKGhhcyAmJiBpc1ZhbGlkKSByZXR1cm4gdHJ1ZTtcblxuICAgIHRoaXMuc3RvcmFnZS5kZWxldGUoa2V5KTtcblxuICAgIHJldHVybiBmYWxzZTtcbiAgfVxuXG4gIGdldDxUID0gYW55PihrZXk6IHN0cmluZyk6IEh0dHBSZXNwb25zZTxUPiB7XG4gICAgcmV0dXJuIHRoaXMuX3Jlc29sdmVSZXNwb25zZTxUPih0aGlzLnN0b3JhZ2UuZ2V0KGtleSkhIGFzIEh0dHBSZXNwb25zZTxhbnk+KTtcbiAgfVxuXG4gIGhhcyhrZXk6IHN0cmluZykge1xuICAgIHJldHVybiB0aGlzLnN0b3JhZ2UuaGFzKGtleSk7XG4gIH1cblxuICBzZXQoa2V5OiBzdHJpbmcsIGJvZHk6IEh0dHBSZXNwb25zZTxhbnk+IHwgYW55LCB7IHR0bCwgYnVja2V0IH06IHsgdHRsPzogbnVtYmVyOyBidWNrZXQ/OiBDYWNoZUJ1Y2tldCB9ID0ge30pIHtcbiAgICBsZXQgcmVzcG9uc2UgPSBib2R5O1xuXG4gICAgaWYgKCEoYm9keSBpbnN0YW5jZW9mIEh0dHBSZXNwb25zZSkpIHtcbiAgICAgIHJlc3BvbnNlID0gbmV3IEh0dHBSZXNwb25zZSh7XG4gICAgICAgIGJvZHksXG4gICAgICAgIHN0YXR1czogMjAwLFxuICAgICAgICB1cmw6IGtleVxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgdGhpcy5fc2V0KGtleSwgcmVzcG9uc2UsIHR0bCEpO1xuICAgIGJ1Y2tldCAmJiBidWNrZXQuYWRkKGtleSk7XG4gIH1cblxuICBkZWxldGUoXG4gICAga2V5OiBzdHJpbmcgfCBDYWNoZUJ1Y2tldCxcbiAgICB7IGRlbGV0ZVJlcXVlc3RzLCBkZWxldGVWZXJzaW9ucyB9OiB7IGRlbGV0ZVZlcnNpb25zPzogYm9vbGVhbjsgZGVsZXRlUmVxdWVzdHM/OiBib29sZWFuIH0gPSB7fVxuICApOiB2b2lkIHtcbiAgICBpZiAoa2V5IGluc3RhbmNlb2YgQ2FjaGVCdWNrZXQpIHtcbiAgICAgIGtleS5mb3JFYWNoKHZhbHVlID0+IHRoaXMuZGVsZXRlKHZhbHVlKSk7XG4gICAgICBrZXkuY2xlYXIoKTtcblxuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIHRoaXMuc3RvcmFnZS5kZWxldGUoa2V5KTtcbiAgICB0aGlzLnR0bE1hbmFnZXIuZGVsZXRlKGtleSk7XG4gICAgdGhpcy5xdWV1ZS5kZWxldGUoa2V5KTtcblxuICAgIGlmIChkZWxldGVSZXF1ZXN0cyAhPT0gZmFsc2UpIHtcbiAgICAgIHRoaXMuX2dldFJlcXVlc3RzKCkuZGVsZXRlKGtleSk7XG4gICAgfVxuXG4gICAgaWYgKGRlbGV0ZVZlcnNpb25zICE9PSBmYWxzZSkge1xuICAgICAgdGhpcy5fZ2V0VmVyc2lvbnMoKS5kZWxldGUoa2V5KTtcbiAgICB9XG4gIH1cblxuICBjbGVhcigpIHtcbiAgICB0aGlzLnN0b3JhZ2UuY2xlYXIoKTtcbiAgICB0aGlzLnR0bE1hbmFnZXIuY2xlYXIoKTtcbiAgICB0aGlzLnF1ZXVlLmNsZWFyKCk7XG4gICAgdGhpcy5fZ2V0VmVyc2lvbnMoKS5jbGVhcigpO1xuICAgIHRoaXMuX2dldFJlcXVlc3RzKCkuY2xlYXIoKTtcbiAgfVxuXG4gIF9nZXRRdWV1ZSgpIHtcbiAgICByZXR1cm4gdGhpcy5xdWV1ZTtcbiAgfVxuXG4gIF9nZXRSZXF1ZXN0cygpIHtcbiAgICByZXR1cm4gdGhpcy5yZXF1ZXN0cztcbiAgfVxuXG4gIF9nZXRWZXJzaW9ucygpIHtcbiAgICByZXR1cm4gdGhpcy52ZXJzaW9uO1xuICB9XG5cbiAgX2lzQ2FjaGVhYmxlKGNhbkFjdGl2YXRlOiBib29sZWFuLCBjYWNoZTogYm9vbGVhbikge1xuICAgIGNvbnN0IHN0cmF0ZWd5ID0gdGhpcy5jb25maWcuc3RyYXRlZ3k7XG5cbiAgICBpZiAoc3RyYXRlZ3kgPT09ICdleHBsaWNpdCcpIHtcbiAgICAgIHJldHVybiBjYWNoZTtcbiAgICB9XG5cbiAgICBpZiAoY2FuQWN0aXZhdGUgJiYgc3RyYXRlZ3kgPT09ICdpbXBsaWNpdCcpIHtcbiAgICAgIHJldHVybiBjYWNoZSAhPT0gZmFsc2U7XG4gICAgfVxuXG4gICAgcmV0dXJuIGZhbHNlO1xuICB9XG5cbiAgX3NldChrZXk6IHN0cmluZywgcmVzcG9uc2U6IEh0dHBSZXNwb25zZTxhbnk+IHwgYm9vbGVhbiwgdHRsOiBudW1iZXIpIHtcbiAgICB0aGlzLnN0b3JhZ2Uuc2V0KGtleSwgcmVzcG9uc2UpO1xuICAgIHRoaXMudHRsTWFuYWdlci5zZXQoa2V5LCB0dGwpO1xuICB9XG5cbiAgX2NhbkFjdGl2YXRlKHJlcXVlc3Q6IEh0dHBSZXF1ZXN0PGFueT4pIHtcbiAgICByZXR1cm4gdGhpcy5ndWFyZC5jYW5BY3RpdmF0ZShyZXF1ZXN0KTtcbiAgfVxuXG4gIF9yZXNvbHZlUmVzcG9uc2U8VCA9IGFueT4oZXZlbnQ6IEh0dHBSZXNwb25zZTxUPik6IEh0dHBSZXNwb25zZTxUPiB7XG4gICAgcmV0dXJuIHRoaXMuY29uZmlnLnJlc3BvbnNlU2VyaWFsaXplciA/IGV2ZW50LmNsb25lKHsgYm9keTogdGhpcy5jb25maWcucmVzcG9uc2VTZXJpYWxpemVyKGV2ZW50LmJvZHkpIH0pIDogZXZlbnQ7XG4gIH1cbn1cbiJdfQ==