import { Inject, Injectable, PLATFORM_ID } from '@angular/core';
import { HttpResponse } from '@angular/common/http';
import { of } from 'rxjs';
import { share, tap } from 'rxjs/operators';
import { HTTP_CACHE_CONFIG } from './cache-config';
import { CACHE_CONTEXT } from './cache-context';
import { isPlatformServer } from '@angular/common';
import * as i0 from "@angular/core";
import * as i1 from "./cache-manager.service";
import * as i2 from "./key-serializer";
export class HttpCacheInterceptor {
    constructor(httpCacheManager, keySerializer, platformId, config) {
        this.httpCacheManager = httpCacheManager;
        this.keySerializer = keySerializer;
        this.platformId = platformId;
        this.config = config;
    }
    intercept(request, next) {
        const context = request.context.get(CACHE_CONTEXT);
        if (isPlatformServer(this.platformId)) {
            return next.handle(request);
        }
        const key = this.keySerializer.serialize(request, context);
        const { cache = this.config.strategy === 'implicit', ttl, bucket, clearCachePredicate, version, mode, returnSource } = context;
        if (version) {
            const versions = this.httpCacheManager._getVersions();
            const currentVersion = versions.get(key);
            if (currentVersion !== version) {
                this.httpCacheManager.delete(key);
            }
            versions.set(key, version);
        }
        if (key && clearCachePredicate) {
            const requests = this.httpCacheManager._getRequests();
            const clearCache = clearCachePredicate(requests.get(key), requests.set(key, request).get(key), key);
            if (clearCache) {
                this.httpCacheManager.delete(key, { deleteRequests: false, deleteVersions: false });
            }
        }
        const canActivate = this.httpCacheManager._canActivate(request);
        if (this.httpCacheManager._isCacheable(canActivate, cache)) {
            const queue = this.httpCacheManager._getQueue();
            bucket && bucket.add(key);
            if (queue.has(key)) {
                return queue.get(key);
            }
            if (this.httpCacheManager.validate(key)) {
                return mode === 'stateManagement' ? returnSource : of(this.httpCacheManager.get(key));
            }
            const shared = next.handle(request).pipe(tap(event => {
                if (event instanceof HttpResponse) {
                    if (mode === 'stateManagement') {
                        this.httpCacheManager._set(key, true, ttl || this.config.ttl);
                    }
                    else {
                        const cache = this.httpCacheManager._resolveResponse(event);
                        this.httpCacheManager._set(key, cache, ttl || this.config.ttl);
                    }
                    queue.delete(key);
                }
            }, err => queue.delete(key)), share());
            queue.set(key, shared);
            return shared;
        }
        return next.handle(request);
    }
}
HttpCacheInterceptor.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "14.2.10", ngImport: i0, type: HttpCacheInterceptor, deps: [{ token: i1.HttpCacheManager }, { token: i2.KeySerializer }, { token: PLATFORM_ID }, { token: HTTP_CACHE_CONFIG }], target: i0.ɵɵFactoryTarget.Injectable });
HttpCacheInterceptor.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "14.2.10", ngImport: i0, type: HttpCacheInterceptor });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "14.2.10", ngImport: i0, type: HttpCacheInterceptor, decorators: [{
            type: Injectable
        }], ctorParameters: function () { return [{ type: i1.HttpCacheManager }, { type: i2.KeySerializer }, { type: Object, decorators: [{
                    type: Inject,
                    args: [PLATFORM_ID]
                }] }, { type: undefined, decorators: [{
                    type: Inject,
                    args: [HTTP_CACHE_CONFIG]
                }] }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2FjaGUtaW50ZXJjZXB0b3IuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9wcm9qZWN0cy9uZ25lYXQvY2FzaGV3L3NyYy9saWIvY2FjaGUtaW50ZXJjZXB0b3IudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLE1BQU0sRUFBRSxVQUFVLEVBQUUsV0FBVyxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ2hFLE9BQU8sRUFBd0QsWUFBWSxFQUFFLE1BQU0sc0JBQXNCLENBQUM7QUFDMUcsT0FBTyxFQUFjLEVBQUUsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUN0QyxPQUFPLEVBQUUsS0FBSyxFQUFFLEdBQUcsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQzVDLE9BQU8sRUFBRSxpQkFBaUIsRUFBbUIsTUFBTSxnQkFBZ0IsQ0FBQztBQUlwRSxPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFDaEQsT0FBTyxFQUFFLGdCQUFnQixFQUFFLE1BQU0saUJBQWlCLENBQUM7Ozs7QUFHbkQsTUFBTSxPQUFPLG9CQUFvQjtJQUMvQixZQUNVLGdCQUFrQyxFQUNsQyxhQUE0QixFQUNQLFVBQWtCLEVBQ1osTUFBdUI7UUFIbEQscUJBQWdCLEdBQWhCLGdCQUFnQixDQUFrQjtRQUNsQyxrQkFBYSxHQUFiLGFBQWEsQ0FBZTtRQUNQLGVBQVUsR0FBVixVQUFVLENBQVE7UUFDWixXQUFNLEdBQU4sTUFBTSxDQUFpQjtJQUN6RCxDQUFDO0lBRUosU0FBUyxDQUFDLE9BQXlCLEVBQUUsSUFBaUI7UUFDcEQsTUFBTSxPQUFPLEdBQUcsT0FBTyxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsYUFBYSxDQUFDLENBQUM7UUFFbkQsSUFBSSxnQkFBZ0IsQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLEVBQUU7WUFDckMsT0FBTyxJQUFJLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxDQUFDO1NBQzdCO1FBRUQsTUFB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QUFFLEdBQUcsSUFBSSxJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDO3FCQUNoRTtvQkFDRCxLQUFLLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDO2lCQUNuQjtZQUNILENBQUMsRUFDRCxHQUFHLENBQUMsRUFBRSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQ3pCLEVBQ0QsS0FBSyxFQUFFLENBQ1IsQ0FBQztZQUVGLEtBQUssQ0FBQyxHQUFHLENBQUMsR0FBRyxFQUFFLE1BQU0sQ0FBQyxDQUFDO1lBRXZCLE9BQU8sTUFBTSxDQUFDO1NBQ2Y7UUFFRCxPQUFPLElBQUksQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLENBQUM7SUFDOUIsQ0FBQzs7a0hBdEZVLG9CQUFvQiwrRUFJckIsV0FBVyxhQUNYLGlCQUFpQjtzSEFMaEIsb0JBQW9COzRGQUFwQixvQkFBb0I7a0JBRGhDLFVBQVU7OzBCQUtOLE1BQU07MkJBQUMsV0FBVzs7MEJBQ2xCLE1BQU07MkJBQUMsaUJBQWlCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0LCBJbmplY3RhYmxlLCBQTEFURk9STV9JRCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgSHR0cEV2ZW50LCBIdHRwSGFuZGxlciwgSHR0cEludGVyY2VwdG9yLCBIdHRwUmVxdWVzdCwgSHR0cFJlc3BvbnNlIH0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uL2h0dHAnO1xuaW1wb3J0IHsgT2JzZXJ2YWJsZSwgb2YgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IHNoYXJlLCB0YXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQgeyBIVFRQX0NBQ0hFX0NPTkZJRywgSHR0cENhY2hlQ29uZmlnIH0gZnJvbSAnLi9jYWNoZS1jb25maWcnO1xuXG5pbXBvcnQgeyBIdHRwQ2FjaGVNYW5hZ2VyIH0gZnJvbSAnLi9jYWNoZS1tYW5hZ2VyLnNlcnZpY2UnO1xuaW1wb3J0IHsgS2V5U2VyaWFsaXplciB9IGZyb20gJy4va2V5LXNlcmlhbGl6ZXInO1xuaW1wb3J0IHsgQ0FDSEVfQ09OVEVYVCB9IGZyb20gJy4vY2FjaGUtY29udGV4dCc7XG5pbXBvcnQgeyBpc1BsYXRmb3JtU2VydmVyIH0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uJztcblxuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIEh0dHBDYWNoZUludGVyY2VwdG9yIGltcGxlbWVudHMgSHR0cEludGVyY2VwdG9yIHtcbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSBodHRwQ2FjaGVNYW5hZ2VyOiBIdHRwQ2FjaGVNYW5hZ2VyLFxuICAgIHByaXZhdGUga2V5U2VyaWFsaXplcjogS2V5U2VyaWFsaXplcixcbiAgICBASW5qZWN0KFBMQVRGT1JNX0lEKSBwcml2YXRlIHBsYXRmb3JtSWQ6IE9iamVjdCxcbiAgICBASW5qZWN0KEhUVFBfQ0FDSEVfQ09ORklHKSBwcml2YXRlIGNvbmZpZzogSHR0cENhY2hlQ29uZmlnXG4gICkge31cblxuICBpbnRlcmNlcHQocmVxdWVzdDogSHR0cFJlcXVlc3Q8YW55PiwgbmV4dDogSHR0cEhhbmRsZXIpOiBPYnNlcnZhYmxlPEh0dHBFdmVudDxhbnk+PiB7XG4gICAgY29uc3QgY29udGV4dCA9IHJlcXVlc3QuY29udGV4dC5nZXQoQ0FDSEVfQ09OVEVYVCk7XG5cbiAgICBpZiAoaXNQbGF0Zm9ybVNlcnZlcih0aGlzLnBsYXRmb3JtSWQpKSB7XG4gICAgICByZXR1cm4gbmV4dC5oYW5kbGUocmVxdWVzdCk7XG4gICAgfVxuXG4gICAgY29uc3Qga2V5ID0gdGhpcy5rZXlTZXJpYWxpemVyLnNlcmlhbGl6ZShyZXF1ZXN0LCBjb250ZXh0KTtcblxuICAgIGNvbnN0IHtcbiAgICAgIGNhY2hlID0gdGhpcy5jb25maWcuc3RyYXRlZ3kgPT09ICdpbXBsaWNpdCcsXG4gICAgICB0dGwsXG4gICAgICBidWNrZXQsXG4gICAgICBjbGVhckNhY2hlUHJlZGljYXRlLFxuICAgICAgdmVyc2lvbixcbiAgICAgIG1vZGUsXG4gICAgICByZXR1cm5Tb3VyY2VcbiAgICB9ID0gY29udGV4dDtcblxuICAgIGlmICh2ZXJzaW9uKSB7XG4gICAgICBjb25zdCB2ZXJzaW9ucyA9IHRoaXMuaHR0cENhY2hlTWFuYWdlci5fZ2V0VmVyc2lvbnMoKTtcbiAgICAgIGNvbnN0IGN1cnJlbnRWZXJzaW9uID0gdmVyc2lvbnMuZ2V0KGtleSk7XG5cbiAgICAgIGlmIChjdXJyZW50VmVyc2lvbiAhPT0gdmVyc2lvbikge1xuICAgICAgICB0aGlzLmh0dHBDYWNoZU1hbmFnZXIuZGVsZXRlKGtleSk7XG4gICAgICB9XG5cbiAgICAgIHZlcnNpb25zLnNldChrZXksIHZlcnNpb24pO1xuICAgIH1cblxuICAgIGlmIChrZXkgJiYgY2xlYXJDYWNoZVByZWRpY2F0ZSkge1xuICAgICAgY29uc3QgcmVxdWVzdHMgPSB0aGlzLmh0dHBDYWNoZU1hbmFnZXIuX2dldFJlcXVlc3RzKCk7XG4gICAgICBjb25zdCBjbGVhckNhY2hlID0gY2xlYXJDYWNoZVByZWRpY2F0ZShyZXF1ZXN0cy5nZXQoa2V5KSEsIHJlcXVlc3RzLnNldChrZXksIHJlcXVlc3QpLmdldChrZXkpISwga2V5KTtcblxuICAgICAgaWYgKGNsZWFyQ2FjaGUpIHtcbiAgICAgICAgdGhpcy5odHRwQ2FjaGVNYW5hZ2VyLmRlbGV0ZShrZXksIHsgZGVsZXRlUmVxdWVzdHM6IGZhbHNlLCBkZWxldGVWZXJzaW9uczogZmFsc2UgfSk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgY29uc3QgY2FuQWN0aXZhdGUgPSB0aGlzLmh0dHBDYWNoZU1hbmFnZXIuX2NhbkFjdGl2YXRlKHJlcXVlc3QpO1xuXG4gICAgaWYgKHRoaXMuaHR0cENhY2hlTWFuYWdlci5faXNDYWNoZWFibGUoY2FuQWN0aXZhdGUsIGNhY2hlISkpIHtcbiAgICAgIGNvbnN0IHF1ZXVlID0gdGhpcy5odHRwQ2FjaGVNYW5hZ2VyLl9nZXRRdWV1ZSgpO1xuXG4gICAgICBidWNrZXQgJiYgYnVja2V0LmFkZChrZXkpO1xuXG4gICAgICBpZiAocXVldWUuaGFzKGtleSkpIHtcbiAgICAgICAgcmV0dXJuIHF1ZXVlLmdldChrZXkpITtcbiAgICAgIH1cblxuICAgICAgaWYgKHRoaXMuaHR0cENhY2hlTWFuYWdlci52YWxpZGF0ZShrZXkpKSB7XG4gICAgICAgIHJldHVybiBtb2RlID09PSAnc3RhdGVNYW5hZ2VtZW50JyA/IHJldHVyblNvdXJjZSEgOiBvZih0aGlzLmh0dHBDYWNoZU1hbmFnZXIuZ2V0KGtleSkpO1xuICAgICAgfVxuXG4gICAgICBjb25zdCBzaGFyZWQgPSBuZXh0LmhhbmRsZShyZXF1ZXN0KS5waXBlKFxuICAgICAgICB0YXAoXG4gICAgICAgICAgZXZlbnQgPT4ge1xuICAgICAgICAgICAgaWYgKGV2ZW50IGluc3RhbmNlb2YgSHR0cFJlc3BvbnNlKSB7XG4gICAgICAgICAgICAgIGlmIChtb2RlID09PSAnc3RhdGVNYW5hZ2VtZW50Jykge1xuICAgICAgICAgICAgICAgIHRoaXMuaHR0cENhY2hlTWFuYWdlci5fc2V0KGtleSwgdHJ1ZSwgdHRsIHx8IHRoaXMuY29uZmlnLnR0bCk7XG4gICAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgY29uc3QgY2FjaGUgPSB0aGlzLmh0dHBDYWNoZU1hbmFnZXIuX3Jlc29sdmVSZXNwb25zZShldmVudCk7XG4gICAgICAgICAgICAgICAgdGhpcy5odHRwQ2FjaGVNYW5hZ2VyLl9zZXQoa2V5LCBjYWNoZSwgdHRsIHx8IHRoaXMuY29uZmlnLnR0bCk7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgcXVldWUuZGVsZXRlKGtleSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfSxcbiAgICAgICAgICBlcnIgPT4gcXVldWUuZGVsZXRlKGtleSlcbiAgICAgICAgKSxcbiAgICAgICAgc2hhcmUoKVxuICAgICAgKTtcblxuICAgICAgcXVldWUuc2V0KGtleSwgc2hhcmVkKTtcblxuICAgICAgcmV0dXJuIHNoYXJlZDtcbiAgICB9XG5cbiAgICByZXR1cm4gbmV4dC5oYW5kbGUocmVxdWVzdCk7XG4gIH1cbn1cbiJdfQ==